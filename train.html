<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <title>CodeBug ‚Äî –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=IBM+Plex+Sans:wght@400;500;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg: #f7f1e7;
            --bg-strong: #f0e6d8;
            --ink: #1a1612;
            --muted: #5f5b54;
            --accent: #0f766e;
            --accent-strong: #0b5f59;
            --warm: #f3b562;
            --card: #fffaf2;
            --stroke: #e2d6c4;
            --shadow: 0 20px 60px rgba(26, 22, 18, 0.12);
            --radius-lg: 22px;
            --radius-md: 16px;
        }
        
        body {
            margin: 0;
            color: var(--ink);
            font-family: "IBM Plex Sans", sans-serif;
            background:
                radial-gradient(1200px 500px at 10% -10%, rgba(15, 118, 110, 0.18), transparent 60%),
                radial-gradient(900px 500px at 90% 0%, rgba(243, 181, 98, 0.25), transparent 60%),
                linear-gradient(180deg, var(--bg), var(--bg-strong));
        }

        ::selection {
            background: rgba(15, 118, 110, 0.2);
        }
        
        * {
            box-sizing: border-box;
        }

        .container {
            width: min(1200px, 92vw);
            margin: 0 auto;
        }

        header {
            height: 72px;
            background: rgba(255, 250, 242, 0.8);
            border-bottom: 1px solid rgba(226, 214, 196, 0.6);
            padding: 0 4vw;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
            backdrop-filter: blur(12px);
            box-shadow: 0 12px 30px rgba(26, 22, 18, 0.08);
        }
        
        .logo {
            font-family: "Space Grotesk", sans-serif;
            font-size: 20px;
            font-weight: 700;
            letter-spacing: 0.4px;
            color: var(--ink);
        }
        
        nav a {
            color: var(--muted);
            margin-left: 25px;
            text-decoration: none;
            font-size: 14px;
            font-weight: 600;
        }
        
        nav a:hover {
            color: var(--accent);
        }
        
        .page {
            margin: 40px auto 80px;
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 40px;
        }
        /* SIDEBAR */
        
        .filters {
            background: var(--card);
            border: 1px solid var(--stroke);
            padding: 22px;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow);
            position: sticky;
            top: 92px;
            align-self: start;
        }

        .filters::after {
            content: "";
            position: absolute;
            inset: -30px -30px auto auto;
            width: 120px;
            height: 120px;
            background: radial-gradient(circle, rgba(243, 181, 98, 0.35), transparent 70%);
            pointer-events: none;
        }
        
        .filters h2 {
            margin: 0;
            color: var(--ink);
            font-size: 22px;
            font-family: "Space Grotesk", sans-serif;
        }
        
        label {
            display: block;
            color: var(--muted);
            margin-top: 18px;
            margin-bottom: 6px;
            font-size: 14px;
            font-weight: 600;
        }

        .filter-tip {
            margin-top: 18px;
            padding: 12px 14px;
            border-radius: 14px;
            background: rgba(15, 118, 110, 0.08);
            font-size: 13px;
            color: var(--muted);
            line-height: 1.5;
        }
        /* SELECT */
        
        .select {
            position: relative;
        }
        
        .select select {
            width: 100%;
            padding: 10px;
            padding-right: 40px;
            background: #fff;
            border: 1px solid var(--stroke);
            border-radius: 12px;
            color: var(--ink);
            appearance: none;
            cursor: pointer;
            font-weight: 600;
        }
        
        .select::after {
            content: "‚ñæ";
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--accent);
            pointer-events: none;
        }
        
        .select select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(15, 118, 110, 0.2);
        }
        /* SEARCH */
        
        input[type="text"] {
            width: 100%;
            padding: 10px;
            background: #fff;
            border: 1px solid var(--stroke);
            border-radius: 12px;
            color: var(--ink);
            font-size: 14px;
            box-sizing: border-box;
        }
        
        input[type="text"]:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(15, 118, 110, 0.2);
        }
        /* MAIN */
        
        .page-head {
            margin-bottom: 18px;
        }

        .page-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 700;
            color: var(--accent);
            background: rgba(15, 118, 110, 0.12);
            margin-bottom: 12px;
        }

        h1 {
            color: var(--ink);
            font-size: 32px;
            margin: 0 0 10px;
            font-family: "Space Grotesk", sans-serif;
        }

        .subtitle {
            color: var(--muted);
            margin-bottom: 0;
            line-height: 1.6;
        }
        
        .top-row {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .daily-card {
            background: linear-gradient(120deg, rgba(15, 118, 110, 0.16), rgba(243, 181, 98, 0.22));
            border-radius: var(--radius-md);
            border: 1px solid rgba(226, 214, 196, 0.9);
            padding: 18px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
        }
        
        .daily-main {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .daily-caption {
            font-size: 14px;
            color: var(--accent);
            font-weight: 700;
        }
        
        .daily-title {
            font-size: 18px;
            font-weight: 600;
        }
        
        .btn-small {
            background: var(--accent);
            border-radius: 12px;
            border: none;
            padding: 8px 16px;
            font-weight: 600;
            cursor: pointer;
            color: #fff;
            font-size: 14px;
            white-space: nowrap;
            box-shadow: 0 12px 28px rgba(15, 118, 110, 0.25);
        }
        
        .btn-small:hover {
            background: var(--accent-strong);
        }
        
        .random-row {
            display: flex;
            justify-content: flex-start;
        }
        
        .btn-random {
            background: #fff;
            border: 1px solid var(--stroke);
            padding: 8px 16px;
            border-radius: 12px;
            color: var(--ink);
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
            box-shadow: 0 10px 24px rgba(26, 22, 18, 0.08);
        }
        
        .btn-random:hover {
            border-color: var(--accent);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--card);
            border: 1px solid var(--stroke);
            border-radius: var(--radius-md);
            overflow: hidden;
            box-shadow: var(--shadow);
        }
        
        th {
            background: rgba(226, 214, 196, 0.4);
            padding: 14px;
            text-align: left;
            border-bottom: 1px solid var(--stroke);
            font-size: 14px;
            letter-spacing: 0.3px;
            text-transform: uppercase;
        }
        
        td {
            padding: 14px;
            border-bottom: 1px solid rgba(226, 214, 196, 0.7);
            font-size: 14px;
        }
        
        tr:hover {
            background: rgba(15, 118, 110, 0.06);
        }
        /* PILL TAGS */
        
        .pill {
            padding: 3px 8px;
            border-radius: 999px;
            border: 1px solid rgba(226, 214, 196, 0.8);
            font-size: 12px;
            background: #fff;
            color: var(--muted);
        }
        
        .link {
            color: var(--accent);
            text-decoration: none;
            font-weight: 600;
        }
        
        .link:hover {
            text-decoration: underline;
        }
        
        .empty {
            padding: 30px;
            background: var(--card);
            border: 1px solid var(--stroke);
            border-radius: var(--radius-md);
            text-align: center;
            margin-top: 20px;
            color: var(--muted);
        }

        .reveal {
            opacity: 0;
            transform: translateY(18px);
            animation: fadeUp 0.7s ease forwards;
            animation-delay: var(--delay, 0s);
        }

        @keyframes fadeUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 960px) {
            .page {
                grid-template-columns: 1fr;
            }

            .filters {
                position: static;
            }
        }

        @media (max-width: 640px) {
            header {
                padding: 0 20px;
            }

            .page {
                margin-top: 24px;
            }

            .daily-card {
                flex-direction: column;
                align-items: flex-start;
            }
        }

        @media (prefers-reduced-motion: reduce) {
            .reveal {
                animation: none;
                opacity: 1;
                transform: none;
            }
        }
    </style>
    <link rel="stylesheet" href="theme-dark.css">
</head>

<body>

    <header>
        <div class="logo">CodeBug</div>
        <nav id="nav-links"></nav>
    </header>

    <main class="page container">

        <!-- SIDEBAR -->
        <div class="filters reveal" style="--delay: 0s;">
            <h2>–§–∏–ª—å—Ç—Ä—ã</h2>

            <label>–°–ª–æ–∂–Ω–æ—Å—Ç—å</label>
            <div class="select">
                <select id="difficulty">
                <option value="">–õ—é–±–∞—è</option>
                <option value="tutorial">–£—á–µ–±–Ω–∞—è</option>
                <option value="easy">–õ—ë–≥–∫–∞—è</option>
                <option value="casual">Casual</option>
                <option value="normal">–ù–æ—Ä–º–∞–ª—å–Ω–∞—è</option>
                <option value="hard">–°–ª–æ–∂–Ω–∞—è</option>
                <option value="insane">–ë–µ–∑—É–º–Ω–∞—è</option>
                <option value="extreme">–≠–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω–∞—è</option>
                <option value="ultra">–£–ª—å—Ç—Ä–∞</option>
                <option value="impossible">–ù–µ–≤–æ–∑–º–æ–∂–Ω–∞—è</option>
                <option value="tourist">–¢—É—Ä–∏—Å—Ç</option>
            </select>
            </div>

            <label>–¢–∏–ø –æ—à–∏–±–∫–∏</label>
            <div class="select">
                <select id="errorType">
                <option value="">–õ—é–±–∞—è</option>
                <option value="–ê–ª–≥–æ—Ä–∏—Ç–º–∏—á–µ—Å–∫–∞—è">–ê–ª–≥–æ—Ä–∏—Ç–º–∏—á–µ—Å–∫–∞—è</option>
                <option value="–ü–∞–º—è—Ç—å">–ü–∞–º—è—Ç—å</option>
                <option value="–í—Ä–µ–º—è">–í—Ä–µ–º—è</option>
                <option value="–§–æ—Ä–º—É–ª—ã">–§–æ—Ä–º—É–ª—ã</option>
            </select>
            </div>

            <label>–ê–≤—Ç–æ—Ä</label>
            <input type="text" id="authorFilter" placeholder="–õ–æ–≥–∏–Ω –∞–≤—Ç–æ—Ä–∞">

            <label>–ü–æ–∏—Å–∫</label>
            <input type="text" id="search">
            <div class="filter-tip">–°–æ–≤–µ—Ç: –Ω–∞—á–Ω–∏ —Å —Ñ–∏–ª—å—Ç—Ä–∞ ¬´–õ—ë–≥–∫–∞—è¬ª –∏ –∑–∞–∫—Ä–µ–ø–∏ –æ—Å–Ω–æ–≤—É –ø–µ—Ä–µ–¥ –æ–ª–∏–º–ø–∏–∞–¥–Ω—ã–º —É—Ä–æ–≤–Ω–µ–º.</div>
        </div>

        <!-- MAIN -->
        <main>
            <div class="page-head reveal" style="--delay: 0.05s;">
                <div class="page-badge">–¢—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—ã–π —Ä–µ–∂–∏–º</div>
                <h1>–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</h1>
                <div class="subtitle">–ü–æ–¥–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞—á—É –ø–æ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –∏–ª–∏ —Ç–∏–ø—É –æ—à–∏–±–∫–∏, –≤—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞—á—É –¥–Ω—è –∏–ª–∏ –≤–æ–∑—å–º–∏—Ç–µ —Ä–∞–Ω–¥–æ–º.</div>
            </div>

            <div class="top-row">
                <!-- –ó–∞–¥–∞—á–∞ –¥–Ω—è -->
                <div class="daily-card reveal" id="daily-card" style="--delay: 0.1s;">
                    <div class="daily-main">
                        <div class="daily-caption">üî• –ó–∞–¥–∞—á–∞ –¥–Ω—è</div>
                        <div class="daily-title" id="daily-title">–ó–∞–≥—Ä—É–∂–∞—é‚Ä¶</div>
                    </div>
                    <button class="btn-small" onclick="openDaily()">–û—Ç–∫—Ä—ã—Ç—å</button>
                </div>

                <!-- –†–∞–Ω–¥–æ–º–Ω–∞—è –∑–∞–¥–∞—á–∞ -->
                <div class="random-row reveal" style="--delay: 0.14s;">
                    <button class="btn-random" onclick="openRandom()">üé≤ –°–ª—É—á–∞–π–Ω–∞—è –∑–∞–¥–∞—á–∞</button>
                </div>
            </div>

            <table class="reveal" style="--delay: 0.18s;">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                        <th>–°–ª–æ–∂–Ω–æ—Å—Ç—å</th>
                        <th>–ê–≤—Ç–æ—Ä</th>
                        <th>–¢–∏–ø –æ—à–∏–±–∫–∏</th>
                        <th>–¢–µ–≥–∏</th>
                    </tr>
                </thead>
                <tbody id="tbody"></tbody>
            </table>

            <div id="empty" class="empty" style="display:none;">–ó–∞–¥–∞—á–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã‚Ä¶</div>
        </main>

    </main>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="firebase.js"></script>
    <script src="auth.js"></script>

    <script>
        // ============================
        // –ó–ê–ì–†–£–ó–ö–ê –ó–ê–î–ê–ß –ò–ó API
        // ============================

        async function loadProblems() {
            console.log("[training] loadProblems() start");
            const base = window.TASKS_API_BASE || "https://codebug.onrender.com";
            try {
                const res = await fetch(`${base}/tasks/list`);
                if (!res.ok) {
                    console.log("[training] fetch list failed, status =", res.status);
                    return [];
                }
                const list = await res.json();
                console.log("[training] total problems loaded:", list.length);
                return list.map(meta => ({
                    id: typeof meta.id === "number" ? meta.id : Number(meta.id),
                    title: meta.title || ("–ó–∞–¥–∞—á–∞ " + meta.id),
                    author: meta.author || "",
                    difficulty: meta.difficulty || "",
                    type: meta.type || "",
                    tags: meta.tags || []
                }));
            } catch (e) {
                console.log("[training] fetch/meta error", e);
                return [];
            }
        }

        async function loadHiddenMap() {
            try {
                const snap = await db.ref("tasksHidden").get();
                return snap.exists() ? snap.val() : {};
            } catch (err) {
                console.warn("[training] hidden map load failed", err);
                return {};
            }
        }

        let problems = [];
        let visibleProblems = [];
        let hiddenMap = {};
        let isAdmin = false;
        let dailyProblem = null;

        async function initTraining() {
            console.log("[training] initTraining()");

            problems = await loadProblems();
            hiddenMap = await loadHiddenMap();
            isAdmin = await checkAdminAccess();
            visibleProblems = problems.filter(p => !hiddenMap[p.id]);

            if (visibleProblems.length === 0) {
                document.getElementById("daily-title").innerText = "–ó–∞–¥–∞—á–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã";
                document.getElementById("daily-card").style.opacity = "0.6";
            } else {
                // –∑–∞–¥–∞—á–∞ –¥–Ω—è ‚Äî –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ –ø–æ –¥–∞—Ç–µ
                const today = new Date();
                const seed = today.getFullYear() * 10000 + (today.getMonth() + 1) * 100 + today.getDate();
                const idx = seed % visibleProblems.length;
                dailyProblem = visibleProblems[idx];

                document.getElementById("daily-title").innerText = dailyProblem.title;
            }

            renderTable();
        }

        // ============================
        // –†–ï–ù–î–ï–† –¢–ê–ë–õ–ò–¶–´
        // ============================

        function diffPill(diff) {
            const map = {
                tutorial: "background:#9aa3ad; color:#111318;",
                easy: "background:#8fe7a1; color:#0b2314;",
                casual: "background:#45d1c2; color:#052b26;",
                normal: "background:#4d7cff; color:#0b1329;",
                hard: "background:#8b5cf6; color:#1a0c2f;",
                insane: "background:#ffb66d; color:#2a1600;",
                extreme: "background:#ff8a3d; color:#2a1200;",
                ultra: "background:#ff8585; color:#2a0b0b;",
                impossible: "background:#ff4d4d; color:#2a0606;",
                tourist: "background:#b8141b; color:#2b0506;"
            };
            let text = diff;
            if (diff === "tutorial") text = "–£—á–µ–±–Ω–∞—è";
            else if (diff === "easy") text = "–õ—ë–≥–∫–∞—è";
            else if (diff === "casual") text = "Casual";
            else if (diff === "normal") text = "–ù–æ—Ä–º–∞–ª—å–Ω–∞—è";
            else if (diff === "hard") text = "–°–ª–æ–∂–Ω–∞—è";
            else if (diff === "insane") text = "–ë–µ–∑—É–º–Ω–∞—è";
            else if (diff === "extreme") text = "–≠–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω–∞—è";
            else if (diff === "ultra") text = "–£–ª—å—Ç—Ä–∞";
            else if (diff === "impossible") text = "–ù–µ–≤–æ–∑–º–æ–∂–Ω–∞—è";
            else if (diff === "tourist") text = "–¢—É—Ä–∏—Å—Ç";

            return `<span class="pill" style="${map[diff] || ""}">${text || "-"}</span>`;
        }

        function typePill(type) {
            if (!type) return `<span class="pill">‚Äî</span>`;
            return `<span class="pill" style="background:#264d7a; color:#d9ecff;">${type}</span>`;
        }

        function tagsPill(tags) {
            if (!Array.isArray(tags) || !tags.length) return `<span class="pill">‚Äî</span>`;
            return tags.map(tag => `<span class="pill">${tag}</span>`).join(" ");
        }

        function renderTable() {
            console.log("[training] renderTable()");

            const diff = document.getElementById("difficulty").value;
            const err = document.getElementById("errorType").value;
            const query = document.getElementById("search").value.toLowerCase();
            const authorQuery = document.getElementById("authorFilter").value.toLowerCase();

            const baseList = isAdmin ? problems : visibleProblems;
            const filtered = baseList.filter(p =>
                (!diff || p.difficulty === diff) &&
                (!err || p.type === err) &&
                (!query || p.title.toLowerCase().includes(query)) &&
                (!authorQuery || (p.author || "").toLowerCase().includes(authorQuery))
            );

            const tbody = document.getElementById("tbody");
            const empty = document.getElementById("empty");

            tbody.innerHTML = "";
            empty.style.display = filtered.length ? "none" : "block";

            filtered.forEach(p => {
                const tr = document.createElement("tr");
                const hiddenBadge = isAdmin && hiddenMap[p.id]
                    ? `<span class="pill" style="background:#3b1d1d; color:#ffb3b3;">–°–∫—Ä—ã—Ç–∞</span>`
                    : "";
                tr.innerHTML = `
                <td>${p.id}</td>
                <td><a class="link" href="problem.html?id=${p.id}">${p.title}</a> ${hiddenBadge}</td>
                <td>${diffPill(p.difficulty)}</td>
                <td>${p.author || "‚Äî"}</td>
                <td>${typePill(p.type)}</td>
                <td>${tagsPill(p.tags)}</td>
            `;
                tbody.appendChild(tr);
            });
        }

        // ============================
        // –ö–ù–û–ü–ö–ò: –ó–ê–î–ê–ß–ê –î–ù–Ø –ò –†–ê–ù–î–û–ú
        // ============================

        function openDaily() {
            console.log("[training] openDaily()");
            if (!dailyProblem) {
                alert("–ó–∞–¥–∞—á–∞ –¥–Ω—è –ø–æ–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞");
                return;
            }
            window.location.href = "problem.html?id=" + dailyProblem.id;
        }

        function openRandom() {
            console.log("[training] openRandom()");
            if (!visibleProblems.length) {
                alert("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∑–∞–¥–∞—á");
                return;
            }
            const idx = Math.floor(Math.random() * visibleProblems.length);
            const p = visibleProblems[idx];
            window.location.href = "problem.html?id=" + p.id;
        }

        // ============================
        // –°–û–ë–´–¢–ò–Ø
        // ============================

        document.addEventListener("DOMContentLoaded", () => {
            console.log("[training] DOMContentLoaded");
            // navbar
            if (typeof updateNavbar === "function") {
                updateNavbar();
            } else {
                console.warn("[training] updateNavbar() –Ω–µ –Ω–∞–π–¥–µ–Ω");
            }

            // —Ñ–∏–ª—å—Ç—Ä—ã
            document.getElementById("difficulty").addEventListener("change", renderTable);
            document.getElementById("errorType").addEventListener("change", renderTable);
            document.getElementById("authorFilter").addEventListener("input", renderTable);
            document.getElementById("search").addEventListener("input", renderTable);

            // –∑–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞—á
            initTraining();
        });
    </script>

</body>

</html>
