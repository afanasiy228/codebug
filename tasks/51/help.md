Используйте 2D префиксные суммы.
