1) Обходим дерево DFS и пронумеровываем вершины временем входа.
2) Поддерево вершины соответствует отрезку [tin[v], tout[v]].
3) Используем Fenwick для суммы на отрезке и точечных обновлений.
