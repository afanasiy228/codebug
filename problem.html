<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <title>CodeBug ‚Äî –ó–∞–¥–∞—á–∞</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=IBM+Plex+Sans:wght@400;500;600&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">

    <style>
         :root {
            --bg: #f7f1e7;
            --bg-strong: #f0e6d8;
            --ink: #1a1612;
            --muted: #5f5b54;
            --accent: #0f766e;
            --accent-strong: #0b5f59;
            --warm: #f3b562;
            --card: #fffaf2;
            --stroke: #e2d6c4;
            --shadow: 0 20px 60px rgba(26, 22, 18, 0.12);
            --radius-lg: 22px;
            --radius-md: 14px;
        }
        
        body {
            margin: 0;
            color: var(--ink);
            font-family: "IBM Plex Sans", sans-serif;
            overflow: hidden;
            background: radial-gradient(1200px 500px at 15% -10%, rgba(15, 118, 110, 0.18), transparent 60%), radial-gradient(900px 500px at 85% 0%, rgba(243, 181, 98, 0.25), transparent 60%), linear-gradient(180deg, var(--bg), var(--bg-strong));
        }
        
         ::selection {
            background: rgba(15, 118, 110, 0.2);
        }
        
        * {
            box-sizing: border-box;
        }
        /* HEADER */
        
        header {
            height: 72px;
            padding: 0 4vw;
            background: rgba(255, 250, 242, 0.8);
            border-bottom: 1px solid rgba(226, 214, 196, 0.6);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
            backdrop-filter: blur(12px);
            box-shadow: 0 12px 30px rgba(26, 22, 18, 0.08);
        }
        
        .logo {
            font-family: "Space Grotesk", sans-serif;
            font-size: 20px;
            font-weight: 700;
            letter-spacing: 0.4px;
            color: var(--ink);
        }
        
        nav a {
            margin-left: 20px;
            color: var(--muted);
            text-decoration: none;
            font-size: 14px;
            font-weight: 600;
        }
        
        nav a:hover {
            color: var(--accent);
        }
        /* LAYOUT */
        
        table td,
        table th {
            text-align: center;
        }
        
        table {
            margin-left: auto;
            margin-right: auto;
        }
        
        .split-v {
            display: flex;
            height: calc(100vh - 72px);
            width: 100%;
            overflow: hidden;
        }
        
        .io-block {
            background: #fff;
            border: 1px solid var(--stroke);
            padding: 10px;
            border-radius: 8px;
            white-space: pre-wrap;
            font-family: monospace;
            margin-top: 4px;
        }
        
        .left {
            width: 40%;
            min-width: 260px;
            max-width: 70%;
            padding: 20px;
            background: var(--card);
            border-right: 1px solid rgba(226, 214, 196, 0.8);
            overflow-y: auto;
            flex-shrink: 0;
        }
        
        .section-title {
            font-family: "Space Grotesk", sans-serif;
            margin: 22px 0 10px;
            font-size: 18px;
            color: var(--ink);
        }
        
        .splitter-v {
            width: 6px;
            cursor: col-resize;
            background: rgba(226, 214, 196, 0.9);
            flex-shrink: 0;
        }
        
        .splitter-v:hover {
            background: var(--accent);
        }
        
        .right {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: rgba(255, 250, 242, 0.7);
            overflow: hidden;
        }
        
        #editorArea {
            flex: 1;
            overflow: hidden;
            padding: 18px 18px 0;
        }
        
        .editor-wrap {
            position: relative;
            height: 100%;
            width: 100%;
            background: #0b1119;
            border: 1px solid var(--stroke);
            border-radius: var(--radius-md);
            overflow: hidden;
        }
        
        #editorHighlight {
            position: absolute;
            inset: 0;
            margin: 0;
            padding: 14px;
            font-family: "IBM Plex Mono", monospace;
            font-size: 14px;
            line-height: 1.45;
            white-space: pre-wrap;
            word-break: break-word;
            color: #e6edf3;
            pointer-events: none;
            overflow: auto;
            scrollbar-width: none;
        }
        
        #editorHighlight::-webkit-scrollbar {
            width: 0;
            height: 0;
        }
        
        #editorHighlight .hl-keyword {
            color: #7dd3fc;
        }
        
        #editorHighlight .hl-type {
            color: #c4b5fd;
        }
        
        #editorHighlight .hl-number {
            color: #fbbf24;
        }
        
        #editorHighlight .hl-string {
            color: #86efac;
        }
        
        #editorHighlight .hl-comment {
            color: #64748b;
            font-style: italic;
        }
        
        #editorHighlight .hl-prep {
            color: #f472b6;
        }
        
        #editor {
            height: 100%;
            width: 100%;
            background: transparent;
            color: transparent;
            resize: none;
            padding: 14px;
            box-sizing: border-box;
            font-family: "IBM Plex Mono", monospace;
            font-size: 14px;
            line-height: 1.45;
            border: none;
            caret-color: #e6edf3;
            -webkit-text-fill-color: transparent;
        }
        
        #editor::selection {
            background: rgba(124, 255, 167, 0.2);
        }
        
        .splitter-h {
            height: 6px;
            cursor: row-resize;
            background: rgba(226, 214, 196, 0.9);
        }
        
        .splitter-h:hover {
            background: var(--accent);
        }
        /* SUBMISSIONS PANEL */
        
        #testsPanel {
            height: 240px;
            min-height: 120px;
            background: var(--card);
            border-top: 1px solid rgba(226, 214, 196, 0.8);
            padding: 16px 18px;
            overflow-y: auto;
        }
        
        .panel-title {
            margin: 0 0 10px;
            color: var(--ink);
            font-family: "Space Grotesk", sans-serif;
            font-size: 16px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            color: var(--ink);
        }
        
        th,
        td {
            border-bottom: 1px solid rgba(226, 214, 196, 0.8);
            padding: 8px;
            font-size: 14px;
        }
        
        th {
            color: var(--ink);
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        .ctrl {
            display: flex;
            gap: 12px;
            padding: 12px 18px 18px;
            background: rgba(255, 250, 242, 0.7);
            border-top: 1px solid rgba(226, 214, 196, 0.8);
        }
        
        #taskStatement {
            font-size: 16.5px;
            line-height: 1.45;
        }
        
        #taskHelp {
            font-size: 16.5px;
            line-height: 1.45;
        }
        
        .btn {
            padding: 8px 16px;
            background: var(--accent);
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            color: #fff;
            box-shadow: 0 12px 24px rgba(15, 118, 110, 0.25);
        }
        
        .btn:hover {
            background: var(--accent-strong);
        }
        
        .testcase {
            margin-bottom: 12px;
            background: #fff;
            padding: 10px;
            border-radius: 10px;
            border: 1px solid var(--stroke);
            white-space: pre-wrap;
        }
        
        .kf-block {
            margin-top: 20px;
        }
        
        .kf-title {
            font-weight: 700;
            margin-bottom: 6px;
            font-size: 16px;
            color: var(--ink);
        }
        
        .kf-io {
            background: #fff;
            border: 1px solid var(--stroke);
            border-radius: 8px;
            padding: 0;
            margin-bottom: 22px;
            position: relative;
        }
        
        .kf-copy {
            position: absolute;
            right: 10px;
            top: 10px;
            background: #f8f1e6;
            border: 1px solid var(--stroke);
            padding: 4px 10px;
            font-size: 12px;
            border-radius: 6px;
            cursor: pointer;
            color: var(--ink);
        }
        
        .kf-copy:hover {
            border-color: var(--accent);
        }
        
        .kf-pre {
            white-space: pre-wrap;
            padding: 16px;
            margin: 0;
            font-family: monospace;
            font-size: 15px;
            line-height: 1.35;
            color: var(--ink);
            background: transparent;
        }
        
        .kf-pre {
            font-size: 13.5px;
            padding: 10px;
            line-height: 1.25;
        }
        
        .testcase-block {
            margin-bottom: 70px;
            /* —Ä–æ–≤–Ω–æ –æ–¥–∏–Ω –º–∞–ª–µ–Ω—å–∫–∏–π –æ—Ç—Å—Ç—É–ø */
        }
        
        #taskTitle {
            font-family: "Space Grotesk", sans-serif;
            margin-top: 0;
        }
        
        .reveal {
            opacity: 0;
            transform: translateY(18px);
            animation: fadeUp 0.7s ease forwards;
            animation-delay: var(--delay, 0s);
        }
        
        @keyframes fadeUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @media (max-width: 980px) {
            body {
                overflow: auto;
            }
            .split-v {
                flex-direction: column;
                height: auto;
            }
            .left {
                width: 100%;
                max-width: 100%;
                border-right: none;
                border-bottom: 1px solid rgba(226, 214, 196, 0.8);
            }
            .splitter-v,
            .splitter-h {
                display: none;
            }
            #editorArea {
                padding: 16px;
            }
            #testsPanel {
                height: auto;
                min-height: 160px;
            }
            .ctrl {
                flex-direction: column;
            }
        }
        
        @media (max-width: 640px) {
            header {
                padding: 0 20px;
            }
        }
        
        @media (prefers-reduced-motion: reduce) {
            .reveal {
                animation: none;
                opacity: 1;
                transform: none;
            }
        }
    </style>
    <link rel="stylesheet" href="theme-dark.css">
</head>

<!-- Firebase -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script src="firebase.js"></script>
<!-- –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–≤–æ–π! -->
<script src="auth.js"></script>
<!-- –∏—Å–ø–æ–ª—å–∑—É–µ—Ç db -->
<script src="globalsubmissions.js"></script>
<!-- –∏—Å–ø–æ–ª—å–∑—É–µ—Ç db -->
<script src="submit.js"></script>

<script>
    console.log("AFTER LOADING FIREBASE:", typeof firebase);
</script>

<!-- =========================================== -->

<body>

    <header>
        <div class="logo">CodeBug</div>
        <nav id="nav-links"></nav>
    </header>

    <div class="split-v">

        <!-- LEFT -->
        <div class="left reveal" id="leftPanel" style="--delay: 0s;">
            <h1 id="taskTitle">...</h1>
            <div id="taskStatement">–ó–∞–≥—Ä—É–∂–∞—é —É—Å–ª–æ–≤–∏–µ‚Ä¶</div>
            <h2 class="section-title">–ü—Ä–∏–º–µ—Ä—ã —Ç–µ—Å—Ç–æ–≤</h2>
            <div id="examples"></div>
            <h3 class="section-title">–ü–æ—è—Å–Ω–µ–Ω–∏–µ</h3>
            <div id="taskHelp">–∑–∞–≥—Ä—É–∂–∞—é –ü–æ—è—Å–Ω–µ–Ω–∏–µ</div>
        </div>

        <div class="splitter-v" id="vSplit"></div>

        <!-- RIGHT -->
        <div class="right reveal" style="--delay: 0.08s;">
            <div id="editorArea">
                <!-- –æ–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä -->
                <div class="editor-wrap">
                    <pre id="editorHighlight" aria-hidden="true"></pre>
                    <textarea id="editor" spellcheck="false"></textarea>
                </div>

            </div>

            <script>
                function escapeHtml(str) {
                    return str
                        .replace(/&/g, "&amp;")
                        .replace(/</g, "&lt;")
                        .replace(/>/g, "&gt;");
                }

                function highlightCpp(code) {
                    let text = escapeHtml(code);
                    const stash = [];

                    const stashToken = (regex, cls) => {
                        text = text.replace(regex, (match) => {
                            const id = stash.length;
                            stash.push(`<span class="${cls}">${match}</span>`);
                            return `{{{${id}}}}`;
                        });
                    };

                    stashToken(/"(?:\\.|[^"\\])*"/g, "hl-string");
                    stashToken(/'(?:\\.|[^'\\])*'/g, "hl-string");
                    stashToken(/\/\*[\s\S]*?\*\//g, "hl-comment");
                    stashToken(/\/\/.*$/gm, "hl-comment");
                    stashToken(/^\s*#.*$/gm, "hl-prep");

                    const parts = text.split(/{{{(\d+)}}}/g);
                    for (let i = 0; i < parts.length; i++) {
                        if (i % 2 === 0) {
                            let segment = parts[i];
                            segment = segment.replace(/\b\d+(?:\.\d+)?(?:[eE][+-]?\d+)?\b/g, '<span class="hl-number">$&</span>');
                            segment = segment.replace(/\b(?:int|long|double|float|bool|char|void|string|size_t|auto|const|constexpr|signed|unsigned|short)\b/g, '<span class="hl-type">$&</span>');
                            segment = segment.replace(/\b(?:if|else|for|while|do|switch|case|break|continue|return|struct|public|private|protected|template|typename|using|namespace|try|catch|throw|new|delete|this|static|inline|virtual|override|final|sizeof|typedef)\b/g, '<span class="hl-keyword">$&</span>');
                            parts[i] = segment;
                        } else {
                            parts[i] = stash[Number(parts[i])] || "";
                        }
                    }

                    return parts.join("");
                }

                function syncHighlight() {
                    const input = document.getElementById("editor");
                    const highlight = document.getElementById("editorHighlight");
                    if (!input || !highlight) return;
                    highlight.scrollTop = input.scrollTop;
                    highlight.scrollLeft = input.scrollLeft;
                }

                function updateHighlight() {
                    const input = document.getElementById("editor");
                    const highlight = document.getElementById("editorHighlight");
                    if (!input || !highlight) return;
                    highlight.innerHTML = highlightCpp(input.value) + "\n";
                    syncHighlight();
                }

                window.editor = {
                    getValue: function() {
                        var el = document.getElementById("editor");
                        if (!el) return "";
                        return el.value;
                    },

                    setValue: function(text) {
                        var el = document.getElementById("editor");
                        if (!el) return;
                        if (text === undefined || text === null) {
                            el.value = "";
                        } else {
                            el.value = text;
                        }
                        updateHighlight();
                    }
                };

                console.log("[editor] textarea mode enabled");
            </script>

            <div class="splitter-h" id="hSplit"></div>

            <div id="testsPanel">
                <h3 class="panel-title">–ü–æ—Å—ã–ª–∫–∏</h3>

                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–í—Ä–µ–º—è</th>
                        </tr>
                    </thead>
                    <tbody id="subs">
                        <tr>
                            <td colspan="4" style="color:var(--muted);text-align:center;">–ü–æ–∫–∞ –Ω–µ—Ç –ø–æ—Å—ã–ª–æ–∫</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="ctrl">
                <button class="btn" onclick="submitCode()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>


    <!-- ===================== GLOBAL SUBMISSIONS ===================== -->
    <script>
        function addSubmissionToTable(idx, sub) {
            const body = document.getElementById("subs");
            const tr = document.createElement("tr");

            const color = sub.status === "OK" ? "#4f4" : "#f55";
            const date = new Date(sub.date).toLocaleTimeString();

            tr.innerHTML = `
        <td>${idx}</td>
        <td style="color:${color}; font-weight:600;">${sub.status}</td>
        <td>${date}</td>
        <td>‚Äî</td>
    `;

            body.appendChild(tr);
        }
    </script>
    <script>
        async function saveGlobalSubmission(user, problem, verdict) {
            const entry = {
                user: String(user),
                problem: String(problem),
                status: String(verdict),
                date: Date.now()
            };

            await firebase.database().ref("submissions").push().set(entry);

            console.log("üî• –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–æ—Å—ã–ª–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞:", entry);
        }
    </script>

    <!-- ===================== SUBMIT CODE ===================== -->
    <script>
        console.log("%c[profile submit.js] –∑–∞–≥—Ä—É–∂–µ–Ω", "color:#0f0; font-weight:bold;");

        /* ============================================================
           SETTINGS
           ============================================================ */

        const SUBMIT_URL = "https://codebug.onrender.com/submit";

        if (!window.firebase) {
            console.error("üî• Firebase –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω!");
        }

        /* ============================================================
           SUBMIT CODE (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è)
           ============================================================ */

        let TASK_DIFFICULTY = "easy";

        async function submitCode() {
            console.log("[submitCode] —Å—Ç–∞—Ä—Ç");

            const url = new URL(window.location.href);
            const taskId = url.searchParams.get("id");

            console.log("taskId =", taskId);

            if (!taskId) {
                alert("–ù–µ—Ç ID –∑–∞–¥–∞—á–∏");
                return;
            }

            const user = getUser();

            if (!user) {
                alert("–∑–∞—Ä–µ–≥—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å —á—Ç–æ–±—ã —Ä–µ—à–∞—Ç—å –∑–∞–¥–∞—á–∏");
                return;
            }

            const code = editor.getValue();
            console.log("code =", code.substring(0, 100), "...");
            try {
                const verdict = await sendToJudge(taskId, code);
                console.log("‚¨Ö –í–µ—Ä–¥–∏–∫—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:", verdict);

                await saveSubmission(user, taskId, verdict.status);
                alert("–í–µ—Ä–¥–∏–∫—Ç: " + verdict.status);
                if (verdict.status === "OK") submitOK(user, taskId, TASK_DIFFICULTY);
                console.log("üíæ Firebase —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ OK");

            } catch (e) {
                console.error("üî• –û—à–∏–±–∫–∞ submitCode:", e);
            }
        }

        /* ============================================================
           SEND TO JUDGE
           ============================================================ */

        async function sendToJudge(taskId, code) {
            console.log("%c[sendToJudge()] ‚Üí fetch()", "color:#aaf");

            const payload = {
                task: taskId,
                code: code
            };

            console.log("Payload JSON:", payload);

            let res;
            try {
                res = await fetch(SUBMIT_URL, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    mode: "cors",
                    body: JSON.stringify(payload)
                });
            } catch (e) {
                console.error("‚ùå –û—à–∏–±–∫–∞ fetch:", e);
                throw new Error("–°–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç");
            }

            console.log("–û—Ç–≤–µ—Ç RAW:", res);

            if (!res.ok) {
                console.error("‚ùå HTTP –æ—à–∏–±–∫–∞:", res.status);
                throw new Error("HTTP " + res.status);
            }

            let data;
            try {
                data = await res.json();
            } catch (e) {
                console.error("‚ùå –û—à–∏–±–∫–∞ JSON:", e);
                throw new Error("–ù–µ–≤–∞–ª–∏–¥–Ω—ã–π JSON");
            }

            console.log("üì¶ JSON:", data);
            return data;
        }

        async function saveSubmission(login, taskId, verdict) {
            console.log("%c[saveSubmission()] ‚Üí GLOBAL ONLY", "color:#fa0;");

            const db = firebase.database();

            const globalRef = db.ref("submissions/global");

            const record = {
                login,
                task: Number(taskId),
                verdict,
                date: Date.now()
            };

            console.log("–ì–ª–æ–±–∞–ª—å–Ω–∞—è –∑–∞–ø–∏—Å—å:", record);

            try {
                await globalRef.push(record);
                console.log("‚úî global push OK");
            } catch (e) {
                console.error("üî• –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:", e);
                throw e;
            }
        }

        function getCurrentTaskId() {
            const url = new URL(location.href);
            return Number(url.searchParams.get("id") || 0);
        }

        /* ============================================================
   LOAD USER SUBMISSIONS (–ø–æ—Å—ã–ª–∫–∏ –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –∑–∞–¥–∞—á–µ)
   ============================================================ */

        async function loadMySubsForThisProblem() {
            console.log("%c[loadMySubsForThisProblem()]", "color:#0af;");

            const user = getUser();
            if (!user) {
                console.warn("‚ö† –ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Äî —Ç–∞–±–ª–∏—Ü—É –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ–º");
                return;
            }

            const url = new URL(location.href);
            const taskId = Number(url.searchParams.get("id"));

            const tbody = document.getElementById("subs");
            if (!tbody) {
                console.error("‚ùå tbody #subs –Ω–µ –Ω–∞–π–¥–µ–Ω!");
                return;
            }

            tbody.innerHTML = "<tr><td colspan='3' style='color:#999'>–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</td></tr>";

            const snap = await firebase.database()
                .ref("submissions/global")
                .get();

            if (!snap.exists()) {
                tbody.innerHTML = "<tr><td colspan='3'>–ü–æ–∫–∞ –Ω–µ—Ç –ø–æ—Å—ã–ª–æ–∫‚Ä¶</td></tr>";
                return;
            }

            const all = Object.values(snap.val());

            const mine = all
                .filter(s => s.login === user && Number(s.task) === Number(taskId))
                .sort((a, b) => b.date - a.date);

            if (mine.length === 0) {
                tbody.innerHTML = "<tr><td colspan='3'>–ü–æ–∫–∞ –Ω–µ—Ç –ø–æ—Å—ã–ª–æ–∫‚Ä¶</td></tr>";
                return;
            }

            tbody.innerHTML = "";
            let i = mine.length;

            for (let s of mine) {
                const verdictColor =
                    s.verdict === "OK" ? "#7fff7f" :
                    s.verdict === "WA" ? "#ff7777" :
                    s.verdict === "RE" ? "#ffb37c" :
                    "#ffd451";

                tbody.innerHTML += `
        <tr>
            <td>${i--}</td>
            <td style="color:${verdictColor}; font-weight:600;">
                ${s.verdict}
            </td>
            <td>${new Date(s.date).toLocaleTimeString()}</td>
        </tr>`;
            }
        }


        async function submitOK(user, taskId, difficulty) {
            console.log("%c[submitOK()] START", "color:#0f0; font-weight:bold;");
            console.log("‚Üí user:", user, " taskId:", taskId, " difficulty:", difficulty);

            if (!user) {
                console.error("‚ùå submitOK: user = null");
                return;
            }

            const ref = firebase.database().ref("users/" + user + "/stats");

            let snap;
            try {
                snap = await ref.get();
            } catch (e) {
                console.error("üî• ERROR loading stats:", e);
                return;
            }

            let data = snap.val();
            console.log("‚úî Loaded stats:", data);

            // === –ì–õ–ê–í–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï ===
            if (!data) data = {};
            if (!data.solved) data.solved = {};
            if (!data.exp) data.exp = 0;
            if (!data.cnt) data.cnt = 0;

            console.log("‚úî After fix:", data);

            // —É–∂–µ —Ä–µ—à–µ–Ω–∞
            if (data.solved[taskId]) {
                console.log("‚úì Task already solved ‚Üí stop");
                return;
            }

            // –æ—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ —Ä–µ—à—ë–Ω–Ω—É—é
            data.solved[taskId] = true;

            // XP
            let addXP = 0;
            if (difficulty === "tutorial") addXP = 2;
            else if (difficulty === "easy") addXP = 4;
            else if (difficulty === "casual") addXP = 7;
            else if (difficulty === "normal") addXP = 12;
            else if (difficulty === "hard") addXP = 20;
            else if (difficulty === "insane") addXP = 30;
            else if (difficulty === "extreme") addXP = 45;
            else if (difficulty === "ultra") addXP = 60;
            else if (difficulty === "impossible") addXP = 80;
            else if (difficulty === "tourist") addXP = 110;
            else addXP = 5;

            data.exp += addXP;
            data.cnt = Object.keys(data.solved).length;

            console.log("üî• NEW STATS:", data);

            try {
                await ref.set(data);
                console.log("‚úî Stats saved");
            } catch (e) {
                console.error("üî• ERROR saving stats:", e);
            }
        }
    </script>



    <!-- ===================== COPY INPUT BUTTON ===================== -->
    <script>
        function copyKF(btn) {
            const pre = btn.parentElement.querySelector(".kf-pre");
            if (!pre) return;

            const text = pre.innerText;
            navigator.clipboard.writeText(text).then(() => {
                btn.innerText = "–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ";
                setTimeout(() => (btn.innerText = "–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å"), 8);
            });
        }
    </script>

    <!-- ===================== LOAD USER SUBMISSIONS ON START ===================== -->
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            updateNavbar();
            loadMySubsForThisProblem();
        });
    </script>

    <!-- ===================== VERTICAL + HORIZONTAL SPLITTERS ===================== -->
    <script>
        // –°–ª–∞–π–¥–µ—Ä—ã –æ—Å—Ç–∞–≤–ª–µ–Ω—ã –∫–∞–∫ –±—ã–ª–∏

        let vSplit = document.getElementById("vSplit");
        let left = document.getElementById("leftPanel");
        let isV = false;

        vSplit.addEventListener("mousedown", () => isV = true);
        document.addEventListener("mouseup", () => {
            isV = false;
            isH = false;
        });

        document.addEventListener("mousemove", e => {
            let needUpdate = false;

            if (isV) {
                let w = e.clientX;
                if (w < 200) w = 200;
                if (w > window.innerWidth * 0.7) w = window.innerWidth * 0.7;
                left.style.width = w + "px";
                needUpdate = true;
            }

            if (isH) {
                let newHeight = window.innerHeight - e.clientY - 70;
                if (newHeight < 120) newHeight = 120;
                if (newHeight > window.innerHeight * 0.7) newHeight = window.innerHeight * 0.7;
                testsPanel.style.height = newHeight + "px";
                needUpdate = true;
            }

            if (needUpdate) {
                const editorContainer = document.getElementById("editor");
                editorContainer.style.height =
                    (window.innerHeight - testsPanel.offsetHeight - 90) + "px";

                // Monaco-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–æ–µ —É–±—Ä–∞–ª–∏: –∑–¥–µ—Å—å –±–æ–ª—å—à–µ –Ω–∏—á–µ–≥–æ –Ω–µ –≤—ã–∑—ã–≤–∞–µ–º
            }
        });

        let isH = false;
        const hSplit = document.getElementById("hSplit");
        const testsPanel = document.getElementById("testsPanel");
        hSplit.onmousedown = () => isH = true;
    </script>

    <!-- ===================== LOAD TASK (meta + tests) ===================== -->
    <script>
        function renderMarkdown(md) {
            if (window.marked && window.DOMPurify) {
                const html = marked.parse(md || "");
                return DOMPurify.sanitize(html);
            }
            return (md || "").replace(/\n/g, "<br>");
        }

        async function loadTask() {

            const url = new URL(location.href);
            const id = url.searchParams.get("id") || "0";


            // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî META.JSON ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
            const metaPath = `tasks/${id}/meta.json`;

            try {
                const res = await fetch(metaPath);

                const meta = await res.json();

                TASK_DIFFICULTY = meta.difficulty;
                console.log("–ó–∞–≥—Ä—É–∂–µ–Ω–∞ —Å–ª–æ–∂–Ω–æ—Å—Ç—å:", TASK_DIFFICULTY);

                document.getElementById("taskTitle").innerText = meta.title || "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è";
            } catch (e) {
                document.getElementById("taskTitle").innerText = "–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ";
            }


            // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî STATEMENT.MD ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
            const stmtPath = `tasks/${id}/statement.md`;

            try {
                const res = await fetch(stmtPath);

                const md = await res.text();

                document.getElementById("taskStatement").innerHTML = renderMarkdown(md);
            } catch (e) {
                document.getElementById("taskStatement").innerText = "statement.md –Ω–µ –Ω–∞–π–¥–µ–Ω";
            }

            const helpPath = `tasks/${id}/help.md`;

            try {
                const res = await fetch(helpPath);
                const md = await res.text();

                document.getElementById("taskHelp").innerHTML = renderMarkdown(md);
            } catch (e) {
                document.getElementById("taskHelp").innerText = "help.md –Ω–µ –Ω–∞–π–¥–µ–Ω";
            }


            // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî CODE.CPP ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
            const codePath = `tasks/${id}/code.cpp`;

            try {
                const res = await fetch(codePath);

                const code = await res.text();

                if (window.editor) {
                    editor.setValue(code);
                } else {}
            } catch (e) {

                if (window.editor) editor.setValue("// code.cpp –Ω–µ –Ω–∞–π–¥–µ–Ω");
            }

            // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî PRIMITIVES TESTS ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
            const examples = document.getElementById("examples");
            examples.innerHTML = "";

            for (let i = 1; i <= 2; i++) {
                console.log(`üìÑ test ${i}`);

                const inPath = `tasks/${id}/tests/${i}.in`;
                const outPath = `tasks/${id}/tests/${i}.out`;

                try {
                    const inpRes = await fetch(inPath);

                    const inp = await inpRes.text();

                    const outRes = await fetch(outPath);

                    const out = await outRes.text();


                    examples.innerHTML += `
                <div class="testcase-block">
                    <div class="kf-title">–¢–µ—Å—Ç ${i}</div>

                    <div class="kf-io">
                        <div class="kf-copy" onclick="copyKF(this)">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</div>
                        <pre class="kf-pre">${inp.trim()}</pre>
                    </div>

                    <div class="kf-title" style="margin-top:10px;">–í—ã–≤–æ–¥</div>
                    <div class="kf-io">
                        <div class="kf-copy" onclick="copyKF(this)">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</div>
                        <pre class="kf-pre">${out.trim()}</pre>
                    </div>
                </div>
            `;
                } catch (e) {
                    console.error(`‚ùå test ${i} ERROR:`, e);
                }
            }

        }
    </script>

    <script>
        console.log("FIREBASE TEST:", typeof firebase);
    </script>

    <script>
        async function testFirebaseWrite() {
            console.log("%c[testFirebaseWrite()] start", "color:#0f0");

            // login –±–µ—Ä—ë–º –∏–∑ auth.js
            const user = getUser() || "anonymous";

            const entry = {
                user: user,
                message: "TEST WRITE OK",
                time: Date.now()
            };

            try {
                // ‚ö†Ô∏è Firebase —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –≤ firebase.js ‚Äî –∑–¥–µ—Å—å –ù–ï —Ç—Ä–æ–≥–∞–µ–º!
                await firebase.database()
                    .ref("submissions_test")
                    .push()
                    .set(entry);

                console.log("üî• Firebase TEST ENTRY ADDED:", entry);
            } catch (e) {
                console.error("‚ùå Firebase write error:", e);
            }
        }
    </script>

    <!-- ===================== SIMPLE TEXT EDITOR –≤–º–µ—Å—Ç–æ Monaco ===================== -->
    <script>
        let editor = {
            setValue() {},
            getValue() {
                return "";
            }
        };

        function initializeTextEditor() {
            const el = document.getElementById("editor");
            if (!el) {
                console.error("editor element not found");
                return;
            }

            editor = {
                setValue(text) {
                    el.value = text ? text : "";
                    if (typeof updateHighlight === "function") {
                        updateHighlight();
                    }
                },
                getValue() {
                    return el.value;
                }
            };

            // –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
            el.value = "// –ó–∞–≥—Ä—É–∂–∞—é code.cpp...";
            if (typeof updateHighlight === "function") {
                updateHighlight();
            }

            if (typeof updateHighlight === "function") {
                el.addEventListener("input", updateHighlight);
            }
            if (typeof syncHighlight === "function") {
                el.addEventListener("scroll", syncHighlight);
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            // —Ä–µ–¥–∞–∫—Ç–æ—Ä –∏ –∑–∞–¥–∞—á–∞
            initializeTextEditor();
            loadTask();
        });
    </script>

</body>

</html>
